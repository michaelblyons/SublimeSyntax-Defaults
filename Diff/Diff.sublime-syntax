%YAML 1.2
---
# https://www.sublimetext.com/docs/syntax.html
# https://www.gnu.org/software/diffutils/manual/diffutils.html
name: Diff
version: 2
file_extensions:
  - diff
  - patch
first_line_match: |-
  (?x)^
      (===\ modified\ file
      |==== \s* // .+ \s - \s .+ \s+ ====
      |Index:[ ]
      |---\ [^%]
      |\*\*\*.*\d{4}\s*$
      |\d+(,\d+)* (a|d|c) \d+(,\d+)* $
      )

variables:
  git_first_line: (?:From \h{40} Mon Sep 17 00:00:00 2001)
  eol: $\r?\n?

scope: source.diff
contexts:
  pop-eol:
    - match: '{{eol}}'
      pop: 1

  pop-before-eol:
    - match: (?={{eol}})
      pop: 1

  main:
    - match: ^(?={{git_first_line}})
      push: Git Diff.sublime-syntax#email-first-line
    - include: line-ranges
    - include: headers
    - include: deltas

  headers:
    # https://www.gnu.org/software/diffutils/manual/diffutils.html#Hunks
    - match: ^-{3}{{eol}}
      scope: meta.separator.diff punctuation.definition.separator.diff

    - include: headers-unified

    - match: ^(\*{15}|={67}){{eol}}
      scope: meta.separator.diff
      captures:
        1: punctuation.definition.separator.diff
    - match: ^(\*{3})[ ](?!$)
      captures:
        1: punctuation.definition.from-file.diff
      push:
        - meta_scope: meta.diff.header.from-file meta.header.from-file.diff
        - include: pop-eol
        - include: dev-null
        - include: path-separators
        - include: date
    - match: ^(={4}) .+(?= - )
      scope: meta.diff.header.from-file meta.header.from-file.diff
      captures:
        1: punctuation.definition.from-file.diff
      push:
        - match: ' (-) .* (={4}){{eol}}'
          scope: meta.diff.header.to-file meta.header.to-file.diff
          captures:
            1: punctuation.definition.to-file.diff
            2: punctuation.definition.to-file.diff
          pop: 1
        - match: ''
          pop: 1
    - match: ^Index(:) (.+){{eol}}
      scope: meta.diff.index meta.index.diff
      captures:
        1: punctuation.separator.key-value.diff
        2: meta.toc-list.file-name.diff

  # https://www.gnu.org/software/diffutils/manual/diffutils.html#Detailed-Unified
  headers-unified:
    - match: ^(-{3})[ ](?!$)
      captures:
        1: punctuation.definition.from-file.diff
      push:
        - meta_scope: meta.diff.header.from-file meta.header.from-file.diff
        - include: pop-eol
        - include: dev-null
        - include: path-separators
        - include: date
    - match: ^(\+{3})[ ](?!$)
      captures:
        1: punctuation.definition.to-file.diff
      push:
        - meta_scope: meta.diff.header.to-file meta.header.to-file.diff
        - include: pop-eol
        - include: dev-null
        - include: path-separators
        - include: date

  line-ranges:
    - include: line-ranges-unified
    # https://www.gnu.org/software/diffutils/manual/diffutils.html#Hunks
    - match: ^\d+(?:(,)\d+)*(?:(a)|(d)|(c))\d+(?:(,)\d+)*{{eol}}
      scope: meta.diff.range.normal meta.range.normal.diff
      captures:
        1: punctuation.separator.sequence.diff
        2: markup.inserted.diff
        3: markup.deleted.diff
        4: markup.changed.diff
    # https://www.gnu.org/software/diffutils/manual/diffutils.html#Example-Context
    - match: |-
        ^(?x:
          ( -{3})[ ].+[ ]( -{4})  # From range
        | (\*{3})[ ].+[ ](\*{4})  # To range
        ){{eol}}
      scope: meta.diff.range.context meta.range.context.diff
      captures:
        1: punctuation.definition.range.diff
        2: punctuation.definition.range.diff
        3: punctuation.definition.range.diff
        4: punctuation.definition.range.diff
    # TODO: diff3
    # # https://www.gnu.org/software/diffutils/manual/diffutils.html#Example-diff3-Normal

  # https://www.gnu.org/software/diffutils/manual/diffutils.html#Detailed-Unified
  line-ranges-unified:
    - match: ^(@@)\s*(.+?)\s*(@@)\s*(.*?)\s*{{eol}}
      scope: meta.diff.range.unified meta.range.unified.diff
      captures:
        1: punctuation.definition.range.diff
        2: meta.toc-list.line-number.diff
        3: punctuation.definition.range.diff
        4: entity.name.section.diff

  deltas:
    # https://www.gnu.org/software/diffutils/manual/diffutils.html#Example-Context
    # https://www.gnu.org/software/diffutils/manual/diffutils.html#Example-Unified
    # https://www.gnu.org/software/diffutils/manual/diffutils.html#Example-Normal
    - match: ^[+>]
      scope: punctuation.definition.inserted.diff
      push: line-inserted
    - match: ^[-<]
      scope: punctuation.definition.deleted.diff
      push: line-deleted
    - match: ^[!|]
      scope: punctuation.definition.changed.diff
      push: line-changed
    # https://www.gnu.org/software/diffutils/manual/diffutils.html#Incomplete-Lines
    - match: ^[\\/()]
      scope: punctuation.definition.comment.begin.diff
      push: line-ignored

  line-deleted:
    - meta_scope: markup.deleted.diff
    - include: pop-eol
    - include: trailing-whitespace
  line-inserted:
    - meta_scope: markup.inserted.diff
    - include: pop-eol
    - include: trailing-whitespace
  line-changed:
    - meta_scope: markup.changed.diff
    - include: pop-eol
    - include: trailing-whitespace
  line-ignored:
    - meta_scope: comment.line.diff
    - include: pop-eol
    - include: trailing-whitespace

  trailing-whitespace:
    - match: '[ \t]*(?=$)'
      scope: meta.whitespace.trailing.diff

  dev-null:
    - match: /dev/null\b
      scope: constant.language.null.diff

  path-separators:
    - match: /|\\
      scope: punctuation.separator.sequence.diff

  date:
    # 1970-01-01 00:00:00 +0000
    - match: \b1970(-)01(-)01 0?0(:)00(:)00(?:(\.)0+)?(?:[ ]([+-]?0000|UTC))?
      scope: meta.date.diff constant.language.null.diff
      captures:
        1: punctuation.separator.sequence.diff
        2: punctuation.separator.sequence.diff
        3: punctuation.separator.sequence.diff
        4: punctuation.separator.sequence.diff
        5: punctuation.separator.decimal.diff
        6: storage.modifier.diff
    # 2002-02-21 23:30:50.442260588 -0800
    - match: \b\d{4}(-)\d\d(-)\d\d \d?\d(:)\d\d(:)\d\d(?:(\.)\d+)?(?:[ ]([+-]?\d{4}))?
      scope: meta.date.diff meta.number.integer.decimal.diff constant.numeric.value.diff
      captures:
        1: punctuation.separator.sequence.diff
        2: punctuation.separator.sequence.diff
        3: punctuation.separator.sequence.diff
        4: punctuation.separator.sequence.diff
        5: punctuation.separator.decimal.diff
        6: storage.modifier.diff
